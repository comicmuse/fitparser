{% extends "base.html" %}
{% block title %}RunCoach - Dashboard{% endblock %}
{% block content %}

<div id="upload-form" class="card" style="display: none;">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h2>Upload FIT File</h2>
    <button type="button" class="btn btn-sm" onclick="toggleUploadForm()">&times; Close</button>
  </div>
  <p style="color: var(--fg-muted); font-size: 0.85rem; margin-bottom: 0.75rem;">
    Upload a run from a .fit file (for runs without Stryd sync)
  </p>
  <form action="{{ url_for('main.upload') }}" method="post" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end;">
      <div style="flex: 2; min-width: 200px;">
        <label style="display: block; font-size: 0.8rem; color: var(--fg-muted); margin-bottom: 0.25rem;">FIT File</label>
        <input type="file" name="fit_file" accept=".fit" required
               style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.4rem; color: var(--fg); width: 100%;">
      </div>
      <div style="flex: 1; min-width: 150px;">
        <label style="display: block; font-size: 0.8rem; color: var(--fg-muted); margin-bottom: 0.25rem;">Activity Name (optional)</label>
        <input type="text" name="activity_name" placeholder="e.g. Morning Run"
               style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.4rem; color: var(--fg); width: 100%;">
      </div>
      <div style="flex: 0 0 auto;">
        <label style="display: block; font-size: 0.8rem; color: var(--fg-muted); margin-bottom: 0.25rem;">Date (optional)</label>
        <input type="date" name="activity_date"
               style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.4rem; color: var(--fg);">
      </div>
      <div style="flex: 0 0 auto;">
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
    </div>
  </form>
</div>

<script>
function toggleUploadForm() {
  var form = document.getElementById('upload-form');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
}
</script>

{# ── Training Calendar ── #}
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
    <h2 style="margin-bottom: 0;">Training Calendar</h2>
    <a href="{{ url_for('main.workouts') }}" class="btn btn-sm">View All</a>
  </div>
  <p style="color: var(--fg-muted); font-size: 0.85rem; margin-bottom: 0.75rem;">
    {{ stats.total_runs }} runs
    {% if stats.pending_parse %} &middot; {{ stats.pending_parse }} pending parse{% endif %}
    {% if stats.pending_analyze %} &middot; {{ stats.pending_analyze }} pending analysis{% endif %}
    {% if stats.errors %} &middot; {{ stats.errors }} errors{% endif %}
    {% if last_sync %}
      &middot; Last sync: {{ last_sync.finished_at or last_sync.started_at }}
    {% endif %}
  </p>

  {# Week labels #}
  {% for week_idx in [0, 1, 2] %}
  <div style="margin-bottom: {{ '0' if week_idx == 2 else '1rem' }};">
    <div style="font-size: 0.75rem; color: var(--fg-muted); text-transform: uppercase; margin-bottom: 0.35rem; font-weight: 600;">
      {% if week_idx == 0 %}Previous Week{% elif week_idx == 1 %}This Week{% else %}Next Week{% endif %}
    </div>
    <div class="cal-grid">
      {% for day in calendar_days %}
      {% if day.week == week_idx %}
      <div class="cal-day {{ 'cal-today' if day.is_today }}{{ ' cal-past' if day.is_past and not day.is_today }}">
        <div class="cal-day-header">
          <span class="cal-weekday">{{ day.weekday }}</span>
          <span class="cal-date">{{ day.day }}</span>
        </div>
        <div class="cal-day-body">
          {% for run in day.actual %}
          <a href="{{ url_for('main.run_detail', run_id=run.id) }}" class="cal-item cal-actual" title="{{ run.workout_name or run.name }}">
            <span class="cal-item-dot" style="background: var(--green);"></span>
            <span class="cal-item-text">{{ (run.workout_name or run.name)|truncate(20, True) }}</span>
          </a>
          {% endfor %}
          {% for pw in day.planned %}
          {% if not day.actual %}
          <div class="cal-item cal-planned" title="{{ pw.title }}">
            <span class="cal-item-dot" style="background: var(--accent);"></span>
            <span class="cal-item-text">{{ pw.title|truncate(20, True) }}</span>
          </div>
          {% endif %}
          {% endfor %}
          {% if not day.actual and not day.planned %}
          <div class="cal-item cal-rest">
            <span style="color: var(--fg-muted); font-size: 0.7rem;">Rest</span>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endfor %}
</div>

{# ── Recent Runs ── #}
{% if recent_runs %}
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h2 style="margin-bottom: 0;">Recent Runs</h2>
    <a href="{{ url_for('main.workouts') }}?runs_page=1" class="btn btn-sm">View All</a>
  </div>
  <div class="table-scroll">
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Name</th>
        <th>Distance</th>
        <th class="hide-mobile">Avg Power</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for run in recent_runs %}
      <tr>
        <td>{{ run.date }}</td>
        <td>
          <a href="{{ url_for('main.run_detail', run_id=run.id) }}">{{ run.workout_name or run.name }}</a>
          {% if run.is_manual_upload %}
            <span class="badge badge-blue" title="Manual upload">Manual</span>
          {% endif %}
        </td>
        <td>
          {% if run.distance_m %}
            {{ "%.1f"|format(run.distance_m / 1000) }} km
          {% else %}
            &mdash;
          {% endif %}
        </td>
        <td class="hide-mobile">
          {% if run.avg_power_w %}
            {{ run.avg_power_w|int }} W
          {% else %}
            &mdash;
          {% endif %}
        </td>
        <td>
          {% if run.stage == 'analyzed' %}
            <span class="badge badge-green">Analyzed</span>
          {% elif run.stage == 'parsed' %}
            <span class="badge badge-blue">Parsed</span>
          {% elif run.stage == 'synced' %}
            <span class="badge badge-yellow">Synced</span>
          {% elif run.stage == 'error' %}
            <span class="badge badge-red" title="{{ run.error_message }}">Error</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
</div>
{% endif %}

{% if syncing is defined and syncing %}
<script>
(function() {
  var poll = setInterval(function() {
    fetch('/status').then(function(r) { return r.json(); }).then(function(d) {
      if (!d.syncing) { clearInterval(poll); location.reload(); }
    }).catch(function() {});
  }, 10000);
})();
</script>
{% endif %}
{% endblock %}
